<?php
    session_start();
    require("../common/common.php");
    require("../config/db-config.php");
    require("../helpers/ques-set.php");

    $candidate_id = $_SESSION['candidate_id'];
    $serial = $_POST['serial'];
    $mark_serial = $_POST['mark_serial'];
    $questions = $_POST['json'];
    $response_table = $_SESSION['sec_id'] . "_response";

    $mark = "q" . $mark_serial;
    $query = "UPDATE `$response_table` SET `$mark` = 6 WHERE `candidate_id` = '$candidate_id'";
    $result = mysqli_query($conn, $query);
    if(!$result) {
        echo mysqli_error($conn);
        die($query);
    }

    ?>
    <script>
        changeColor(<?= $mark_serial ?>, 6);
    </script>
    <?php

    $col = "q" . $serial;
    $query = "SELECT `$col` AS `original`, ABS(`$col`) AS `$col` FROM `$response_table` WHERE `candidate_id` = '$candidate_id'";
    $result = mysqli_query($conn, $query);
    if(!$result) {
        echo mysqli_error($conn);
        die($query);
    }

    $row = mysqli_fetch_array($result, MYSQLI_ASSOC);

    ?>
    <script>
        changeColor(<?= $mark_serial ?>, <?= $row['original'] ?>);
    </script>
    <?php

    $response = "opt_" . $row[$col] . "_" . $serial;

    if($row[$col] == 0) {
        $query = "UPDATE `$response_table` SET `$col` = 5 WHERE `candidate_id` = '$candidate_id'";
        $result = mysqli_query($conn, $query);
        if(!$result) {
            echo mysqli_error($conn);
            die($query);
        }
    }

?>

<div class="ques-container">
    <?= updateQues($serial, $questions) ?>
</div>


<script>
    var response = "<?= $response ?>";
    var id;
    id = "#" + response;
    $(id).prop('checked', true);

    var sl_id;
    var sl_ques;

    $(".clear-sl").click(function() {
        sl_ques = $(this).attr("data-serial");
        sl_id = "#opt_5_" + sl_ques;
        $(sl_id).trigger('click');
    });
</script>
